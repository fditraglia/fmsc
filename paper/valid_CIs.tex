%!TEX root = main.tex

\subsection{Valid Confidence Intervals}
While Corollary \ref{cor:momentavg} characterizes the limiting behavior of moment-average, and hence post-selection estimators, the limiting random variable $\Lambda(\tau)$ is a complicated function of the normal random vector $M$. 
Because this distribution is analytically intractable, I adapt a suggestion from \cite{ClaeskensHjortbook} and approximate it by simulation.
The result is a conservative procedure that provides asymptotically valid confidence intervals for moment average and hence post-conservative selection estimators.\footnote{Although I originally developed this procedure by analogy to \cite{ClaeskensHjortbook}, \cite{Leeb} kindly pointed out that constructions of the kind given here have appeared elsewhere in the statistics literature, notably in \cite{Loh1985}, \cite{Berger1994}, and \cite{Silvapulle1996}. 
More recently, \cite{McCloskey} uses a similar approach to study non-standard testing problems.}
 
First, suppose that $K_S$, $\varphi_S$, $\theta_0$, $\Omega$ and $\tau$ were known. 
Then, by simulating from $M$, as defined in Theorem \ref{thm:normality}, the distribution of $\Lambda(\tau)$, defined in Corollary \ref{cor:momentavg}, could be approximated to arbitrary precision. 
To operationalize this procedure, substitute consistent estimators of $K_S$, $\theta_0$, and $\Omega$, e.g.\ those used to calculate FMSC. 
To estimate $\varphi_S$, we first need to derive the limit distribution of $\widehat{\omega}_S$, the data-based weights specified by the user. 
As an example, consider the case of moment selection based on the FMSC. Here $\widehat{\omega}_S$ is simply the indicator function
\begin{equation}
	\label{eq:FMSCindicate}
	\widehat{\omega}_S = \mathbf{1}\left\{\mbox{FMSC}_n(S) = \min_{S'\in \mathscr{S}} \mbox{FMSC}_n(S')\right\}
\end{equation}
To estimate $\varphi_S$, we first substitute consistent estimators of $\Omega$, $K_S$ and $\theta_0$ into $\mbox{FMSC}_S(\tau,M)$, defined in Corollary \ref{cor:FMSClimit}, yielding,
\begin{equation}
	\widehat{\mbox{FMSC}}_S(\tau,M) = \nabla_\theta\mu(\widehat{\theta})'\widehat{K}_S\Xi_S \left\{\left[\begin{array}{cc}0&0\\0&\widehat{\mathcal{B}}(\tau,M) \end{array}\right] + \widehat{\Omega}\right\}\Xi_S'\widehat{K}_S'\nabla_\theta\mu(\widehat{\theta}).
\end{equation}
where
\begin{equation}
	\widehat{\mathcal{B}}(\tau,M) = (\widehat{\Psi} M + \tau)(\widehat{\Psi} M + \tau)' - \widehat{\Psi} \widehat{\Omega} \widehat{\Psi}
\end{equation}
Combining this with Equation \ref{eq:FMSCindicate},
\begin{equation}
\label{eq:omegahat}
	\widehat{\varphi}_S(\tau,M) = \mathbf{1}\left\{\widehat{\mbox{FMSC}}_S(\tau,M) = \min_{S'\in \mathscr{S}} \widehat{\mbox{FMSC}}_{S'}(\tau,M)\right\}
\end{equation}
For GMM-AIC moment selection or selection based on a downward $J$-test, $\varphi_S(\cdot,\cdot)$ may be estimated analogously, following  Theorem \ref{pro:jstat}. 

Although simulating draws from $M$, defined in Theorem \ref{thm:normality}, requires only an estimate of $\Omega$, the limit $\varphi_S$ of the weight function also depends on $\tau$. 
As discussed above, no consistent estimator of $\tau$ is available under local mis-specification: the estimator $\widehat{\tau}$ has a non-degenerate limit distribution (see Theorem \ref{thm:tau}). 
Thus, substituting $\widehat{\tau}$ for $\tau$ will give erroneous results by failing to account for the uncertainty that enters through $\widehat{\tau}$. 
The solution is to use a two-stage procedure. 
First construct a  $100(1-\delta)\%$ confidence region $\mathscr{T}(\widehat{\tau},\delta)$ for $\tau$ using Theorem \ref{thm:tau}. 
Then, for each $\tau^* \in \mathscr{T}(\widehat{\tau},\delta)$ simulate from the distribution of $\Lambda(\tau^*)$, defined in Corollary \ref{cor:momentavg}, to obtain a \emph{collection} of $(1-\alpha)\times 100\%$ confidence intervals indexed by $\tau^*$. 
Taking the lower and upper bounds of these yields a \emph{conservative} confidence interval for $\widehat{\mu}$, as defined in defined in Equation \ref{eq:avg}. 
This interval has asymptotic coverage probability of \emph{at least} $(1-\alpha-\delta)\times 100\%$.
The precise algorithm is as follows.
\begin{alg}[Simulation-based Confidence Interval for $\widehat{\mu}$]
\label{alg:conf}
\mbox{}
\begin{enumerate}
	\item For each $\tau^* \in \mathscr{T}(\widehat{\tau},\delta)$ 
		\begin{enumerate}[(i)]
			\item Generate $J$ independent draws $M_j \sim N_{p+q}( 0, \widehat{\Omega} )$
			\item Set $\Lambda_j(\tau^*) = -\nabla_\theta\mu(\widehat{\theta})'\left[\sum_{S \in \mathscr{S}} \widehat{\varphi}_S(\tau^*,M_j) \widehat{K}_S\Xi_S\right] (M_j + \tau^*)$
			\item Using the draws $\{\Lambda_j(\tau^*)\}_{j=1}^J$, calculate $\widehat{a}(\tau^*)$, $\widehat{b}(\tau^*)$ such that
		$$P\left\{ \widehat{a}(\tau^*) \leq\Lambda(\tau^*)\leq \widehat{b}(\tau^*) \right\} = 1 - \alpha$$
		\end{enumerate}
	\item Set $\displaystyle \widehat{a}_{min}(\widehat{\tau})=\min_{\tau^* \in \mathscr{T}(\widehat{\tau},\delta)} \widehat{a}(\tau^*)$ and $\displaystyle \widehat{b}_{max}(\widehat{\tau})= \max_{\tau^* \in \mathscr{T}(\widehat{\tau},\delta)} \widehat{b}(\tau^*)$ \vspace{0.5em}
	\item The confidence interval for $\mu$ is
				$\displaystyle \mbox{CI}_{sim}=\left[ \widehat{\mu} - \frac{\widehat{b}_{max}(\widehat{\tau})}{\sqrt{n}}, \;\;\; \widehat{\mu} - \frac{\widehat{a}_{min}(\widehat{\tau})}{\sqrt{n}} \right]$
\end{enumerate}
\end{alg}

\begin{thm}[Simulation-based Confidence Interval for $\widehat{\mu}$]
\label{pro:sim}
Let $\widehat{\Psi}$, $\widehat{\Omega}$, $\widehat{\theta}$, $\widehat{K}_S$, $\widehat{\varphi}_S$ be consistent estimators of $\Psi$, $\Omega$, $\theta_0$, $K_S$, $\varphi_S$ and define 
\begin{eqnarray*}
	\Delta_n(\widehat{\tau},\tau^*) &=& \left(\widehat{\tau} - \tau^*\right)' \left(\widehat{\Psi}\widehat{\Omega}\widehat{\Psi}'\right)^{-1} \left(\widehat{\tau} - \tau^*\right)\\
	\mathscr{T}(\widehat{\tau},\delta) &=& \left\{\tau^* \colon  \Delta_n(\widehat{\tau},\tau^*) \leq \chi^2_q(\delta)\right\}
\end{eqnarray*}
where $\chi^2_q(\delta)$ denotes the $1-\delta$ quantile of a $\chi^2$ distribution with $q$ degrees of freedom.
Then, the interval $\mbox{CI}_{sim}$ defined in Algorithm \ref{alg:conf} has asymptotic coverage probability no less than $1-(\alpha + \delta)$ as $J,n\rightarrow \infty$.
\end{thm}

\subsection{Simulation Study: Valid Confidence Intervals}
To evaluate the the performance of Algorithm \ref{alg:conf} in finite-samples, we now revisit the simulation experiments introduced above in Sections \ref{sec:OLSvsIVsim} and \ref{sec:chooseIVsim}.
All results in this section are based on 10,000 simulation replications from the appropriate DGP.
Coverage probabilities and relative widths are all given in percentage points, rounded to the nearest whole percent.

Tables \ref{tab:OLSvsIVsim_cover_naiveFMSC} and \ref{tab:chooseIVsim_cover_naiveFMSC} show the problem of ignoring moment selection by presenting the the actual coverage probability of a na\"{i}ve 90\%, post-FMSC confidence interval.
The na\"{i}ve procedure simply constructs a textbook 90\% interval around the FMSC-selected estimator. 
As such it completely ignores both moment selection uncertainty, and the possibility that the selected estimator shows an asymptotic bias and is hence incorrectly centered.
Table \ref{tab:OLSvsIVsim_cover_naiveFMSC} reports results for the OLS versus 2SLS simulation experiment, and Table \ref{tab:chooseIVsim_cover_naiveFMSC} for the choosing instrumental variables simulation experiment.
In each case, coverage probabilities can be made practically as close to zero as we like by choosing appropriate parameter values.
This effect persists even for large sample sizes.
At the same time, for many values in the parameter space the coverage probabilities are close or even equal to their nominal level.
This is precisely the lack of uniformity described by \cite{LeebPoetscher2005}, and the reason why post-selection inference is such a knotty problem.

\begin{table}[h]
\footnotesize
\centering
	\begin{subtable}{0.48\textwidth}
		\caption{Two-Stage Least Squares}
		\input{../SimulationOLSvsIV/Results/coverage_TSLS.tex}
		\label{tab:OLSvsIVsim_cover_TSLS}
	\end{subtable}	
	~
	\begin{subtable}{0.48\textwidth}
		\caption{Na\"{i}ve post-FMSC}
		\input{../SimulationOLSvsIV/Results/coverage_FMSC_naive.tex}
		\label{tab:OLSvsIVsim_cover_naiveFMSC}
	\end{subtable}
	\caption{Coverage probabilities of nominal 90\% CIs for the OLS versus 2SLS simulation experiment from Section \ref{sec:OLSvsIVsim}, based on 10,000 simulation draws from the DGP given in Equations \ref{eq:OLSvsIVDGP1}--\ref{eq:OLSvsIVDGP3}}
\end{table}


\begin{table}[h]
\footnotesize
\centering
	\begin{subtable}{0.48\textwidth}
		\caption{Valid Estimator}
		\label{tab:chooseIVsim_cover_Valid}
		\input{../SimulationChooseIVs/Results/coverage_Valid.tex}
	\end{subtable}	
	~
	\begin{subtable}{0.48\textwidth}
		\caption{Na\"{i}ve post-FMSC}
		\label{tab:chooseIVsim_cover_naiveFMSC}
		\input{../SimulationChooseIVs/Results/coverage_FMSC_naive.tex}
	\end{subtable}
	\caption{Coverage probabilities of nominal $90\%$ CIs for the choosing instrumental variables simulation experiment described in Section \ref{sec:chooseIVsim}, based on 10,000 simulation draws from the DGP given in Equations \ref{eq:chooseIVDGP1}--\ref{eq:chooseIVDGP3}.}
\end{table}

Table \ref{tab:OLSvsIVsim_cover_FMSC} gives the actual coverage probability of the conservative, 90\% post-FMSC confidence interval, constructed according to Algorithm \ref{alg:conf}, for the OLS versus 2SLS example.
As we see from the table, these intervals achieve their nominal minimum coverage probability uniformly over the parameter space for all sample sizes.
In general, however, they can be quite conservative, particularly for smaller values of $\pi, \rho$ and $N$: coverage probabilities never fall below 94\% and occasionally exceed $99.5\%$.\footnote{Recall that coverage probabilities are given in percentage points, rounded to the nearest whole percent. Thus a value of 100, for example, in fact means $>\geq 99.5$.}
Some conservatism is inevitable given the nature of the two-step procedure, which takes \emph{worst-case} lower and upper bounds over a collection of intervals.
In this example, however, the real culprit is the 2SLS estimator itself.
Table \ref{tab:OLSvsIVsim_cover_TSLS} presents coverage probabilities for a nominal 90\% confidence interval for the 2SLS estimator.
Although this estimator is correctly specified and is not subject to moment selection uncertainty, so that the textbook asymptotic theory applies, coverage probabilities are far above their nominal level for smaller values of $\pi$ even if $N$ is fairly large, a manifestation of the weak instrument problem.
This additional source of conservatism is inherited by the two-step post-FMSC intervals.
Results for the minimum-AMSE moment average estimator, given in Table \ref{tab:OLSvsIVsim_cover_AVG}, are broadly similar.
Although the two-step intervals continue to achieve their nominal minimum coverage probability for all parameter values, they are quite conservative.
If anything, the minimum-AMSE intervals a bit more conserative than the the post-FMSC intervals from Table \ref{tab:OLSvsIVsim_cover_TSLS}.


The worry, of course, is not conservatism as such but the attendent increase in confidence interval width.
Tables \ref{tab:OLSvsIVsim_width_FMSC} and \ref{tab:OLSvsIVsim_width_AVG} compare the median width of the two-step post-FMSC and minimum-AMSE intervals to that of the 2SLS estimator in the OLS verus 2SLS simulation experiment from section \ref{sec:OLSvsIVsim}.
A value of 25, for example indicates that the two-step interval is 25\% wider than the corresponding interval for the 2SLS estimator.
This comparison shows us the inferential cost of carrying out moment selection relative to simply using the correctly-specified 2SLS estimator and calling it a day.
We see immediately that moment selection is not a free lunch: the averaging and post-selection intervals are indeed wider than those of the 2SLS estimator, sometimes considerably so.
Intriguingly, although the minimum-AMSE intervals are generally more conservative than the post-FMSC intervals, they are also considerably shorter for nearly all parameter values.
\begin{table}[h]
\footnotesize
\centering
	\begin{subtable}{0.48\textwidth}
		\caption{post-FMSC Estimator}
		\input{../SimulationOLSvsIV/Results/width_FMSC_correct.tex}
		\label{tab:OLSvsIVsim_width_FMSC}
	\end{subtable}	
	~
	\begin{subtable}{0.48\textwidth}
		\caption{AMSE-Averaging Estimator}
		\input{../SimulationOLSvsIV/Results/width_AVG_correct.tex}
		\label{tab:OLSvsIVsim_width_AVG}
	\end{subtable}
	\caption{Median width of simulation-based $>90\%$ CIs relative to traditional 90\% CI for the 2SLS estimator in the OLS versus 2SLS example. Based on 10,000 simulation draws from the DGP given in Equations \ref{eq:OLSvsIVDGP1}--\ref{eq:OLSvsIVDGP3}.}
\end{table}

Turning our attention now to the choosing instrumental variables simulation experiment from section \ref{sec:chooseIVsim}, 




The situation is qualitatively similar although much less dramatic for the choosing instrumental variables example.
Tables 

Median width relative to traditional 90\% CI for 2SLS in Tables \ref{tab:OLSvsIVsim_width_AVG} \ref{tab:OLSvsIVsim_width_FMSC}.
A fair bit wider, particularly the post-FMSC which is around 40\% wider.
For nearly all parameter values and sample sizes the AVG estimator is narrrower: typically a bit over a third wider than the 2SLS.

Table \ref{tab:chooseIVsim_cover_FMSC} gives the results for the two-step post-FMSC CI in the choosing IVs example.
These intervals can be slightly below their nominal minimum level, particularly for the smaller sample sizes.
At worst 81\% relative to a nominal 90\% when $N=50, \gamma = 0.6, \rho = 0.5$. 
This comes from the fact that the traditional intervals for the valid estimator systematically under-cover except when $N = 500$.
But in general, the two-step intervals work fairly well and they are much less conservative in this example.
Table \ref{tab:chooseIVsim_width_FMSC} gives widths relative to traditional CI for valid estimator.
Not that much wider: worst-case is 22\% wider but generally closer to 10\% wider.
Tables \ref{tab:chooseIVsim_cover_posFMSC} and \ref{tab:chooseIVsim_width_posFMSC} give results for positive part, but these are practically identical.

\begin{table}[h]
\footnotesize
\centering
	\begin{subtable}{0.48\textwidth}
		\caption{FMSC}
		\input{../SimulationOLSvsIV/Results/coverage_FMSC_correct.tex}
		\label{tab:OLSvsIVsim_cover_FMSC}
	\end{subtable}	
	~
	\begin{subtable}{0.48\textwidth}
		\caption{AMSE-Averaging Estimator}
		\input{../SimulationOLSvsIV/Results/coverage_AVG_correct.tex}
		\label{tab:OLSvsIVsim_cover_AVG}
	\end{subtable}
	\caption{Coverage probabilities of two-step, simulation-based nominal $>90\%$ CIs for the OLS versus 2SLS example. Based on 10,000 simulation draws from the DGP given in Equations \ref{eq:OLSvsIVDGP1}--\ref{eq:OLSvsIVDGP3}.}
\end{table}





\begin{table}[h]
\footnotesize
\centering
	\begin{subtable}{0.48\textwidth}
		\caption{FMSC}
		\label{tab:chooseIVsim_cover_FMSC}
		\input{../SimulationChooseIVs/Results/coverage_FMSC_2step.tex}
	\end{subtable}	
	~
	\begin{subtable}{0.48\textwidth}
		\caption{positive-part FMSC}
		\label{tab:chooseIVsim_cover_posFMSC}
		\input{../SimulationChooseIVs/Results/coverage_posFMSC_2step.tex}
	\end{subtable}
	\caption{Coverage probabilities of two-step, simulation-based nominal $>90\%$ CIs for the choosing instrumental variables example. Based on 10,000 simulation draws from the DGP given in Equations \ref{eq:chooseIVDGP1}--\ref{eq:chooseIVDGP3}.}
\end{table}

\todo[inline]{Now talk about width. There's a cost here. Talk about impossibility results etc. Not as bad in the choosing IVs example. Talk about how they could be made shorter, McCloskey, etc.}



\begin{table}[h]
\footnotesize
\centering
	\begin{subtable}{0.48\textwidth}
		\caption{FMSC}
		\label{tab:chooseIVsim_width_FMSC}
		\input{../SimulationChooseIVs/Results/width_FMSC_2step.tex}
	\end{subtable}	
	~
	\begin{subtable}{0.48\textwidth}
		\caption{positive-part FMSC}
		\label{tab:chooseIVsim_width_posFMSC}
		\input{../SimulationChooseIVs/Results/width_posFMSC_2step.tex}
	\end{subtable}
		\caption{Median width of simulation-based $>90\%$ CIs relative to traditional 90\% CI for the Valid estimator in the choosing instrumental variables example. Based on 10,000 simulation draws from the DGP given in Equations \ref{eq:chooseIVDGP1}--\ref{eq:chooseIVDGP3}.}
\end{table}

\todo[inline]{Need to talk about coverage versus width. Explore in the simulations and empirical example. There is a cost to moment selection. But this cost is still present when selection is carried out informally: we're just trying to make it formal here. One could indeed make a case that, if inference is your primary goal, you shouldn't be doing moment selection. We have shown above that if your goal is estimation, moment selection can produce superior estimates. But more generally, people carry out moment selection all the time, albeit informally for example with a J-test and it is useful to have a means of checking the robustness of inferences in this setting. Should also add results looking at the one-step procedure. This will allow me to make the point that it is the worst-case aspect of the problem that makes things difficult. Indeed, should see shorter intervals than the 2SLS in some cases here. Talk about the impossibility results.}